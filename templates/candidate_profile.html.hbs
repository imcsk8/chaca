<!doctype html>
<html lang="en">
  <head>


    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JB6DXVVXBD"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-JB6DXVVXBD');
    </script>

    <title>Perfil de Candidato</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,300,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/public/css/style.css">
    {{> fb_headers }}
  </head>
  <body>

    {{> navbar }}

    <section class="ftco-section">
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-md-8 text-center mb-4">
            <h2 class="heading-section">{{ candidate.fullname }}</h2>
          </div>
        </div>
        
        <div class="row justify-content-center">
          <div class="col-md-10">
            <div class="card">
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4 text-center">
                    {{#if candidate.image_url}}
                    <img src="{{ candidate.image_url }}" alt="{{ candidate.fullname }}" class="img-fluid rounded mb-3" style="max-height: 250px;">
                    {{else}}
                    <img src="/api/placeholder/250/250" alt="No imagen disponible" class="img-fluid rounded mb-3">
                    {{/if}}
                    
                    <div class="candidate-basic-info">
                      <p>
                        <span class="badge badge-primary">
                          {{ candidate.sex }}
                        </span>
                        <span class="badge badge-info">{{ candidate.age }} años</span>
                      </p>

                        <!-- Reaction buttons -->
                        <div class="mt-4 candidate-profile-reactions">
                          <div class="reaction-group">
                            <!-- Like Button -->
                            <button class="btn btn-lg btn-outline-success reaction-btn" data-candidate-id="{{candidate.id}}" data-reaction-type="Like">
                              <i class="fa fa-thumbs-up"></i>
                            </button>
                            <span class="reaction-count" id="like-count-{{candidate.id}}">{{ candidate.like_count }}</span>

                            <!-- Dislike Button -->
                            <button class="btn btn-lg btn-outline-secondary reaction-btn" data-candidate-id="{{candidate.id}}" data-reaction-type="Dislike">
                              <i class="fa fa-thumbs-down"></i>
                            </button>
                            <span class="reaction-count" id="dislike-count-{{candidate.id}}">{{ candidate.dislike_count }}</span>

                            <!-- Danger Button -->
                            <button class="btn btn-lg btn-outline-danger reaction-btn" data-candidate-id="{{candidate.id}}" data-reaction-type="Danger">
                              <i class="fa fa-exclamation-triangle"></i>
                            </button>
                            <span class="reaction-count" id="danger-count-{{candidate.id}}">{{ candidate.danger_count }}</span>
                          </div>
                        </div>


                      <div class="mt-3">
                        {{#if candidate.curriculum_url}}
                        <a href="{{ candidate.curriculum_url }}" target="_blank" class="btn btn-sm btn-info mb-2">
                          <i class="fa fa-file-text-o"></i> Ver Curriculum
                        </a>
                        {{/if}}

                        {{#if candidate.website}}
                        <a href="{{ candidate.website }}" target="_blank" class="btn btn-sm btn-success mb-2">
                          <i class="fa fa-globe"></i> Sitio Web
                        </a>
                        {{/if}}
                        
                        {{#if candidate.candidato_url}}
                        <a href="{{ candidate.candidato_url }}" target="_blank" class="btn btn-sm btn-primary mb-2">
                          <i class="fa fa-external-link"></i> Perfil Oficial
                        </a>
                        {{/if}}
                      </div>

                      <!-- Candidate comments -->
                      <div id="candidate-comments">

                          <h5 class="text-center">Comentarios</h5>

                          <!-- Comment form -->
                          <div class="comment-form mb-3">
                            <textarea id="comment-text" class="form-control mb-2" rows="3" placeholder="Escribe tu comentario..."></textarea>
                            <button id="submit-comment" class="btn btn-primary btn-block" data-candidate-id="{{candidate.id}}">
                              <i class="fa fa-comment"></i> Publicar Comentario
                            </button>
                          </div>

                          <!-- Comments list -->
                          <div class="comments-list">
                            <div id="comments-container">
                              {{#if candidate.comments}}
                                {{#each candidate.comments}}
                                  <div class="comment-item card mb-2">
                                    <div class="card-body">
                                      <h6 class="comment-author">{{this.user_name}}</h6>
                                      <p class="comment-text">{{this.comment_text}}</p>
                                      <small class="text-muted">{{this.created_at}}</small>
                                    </div>
                                  </div>
                                {{/each}}
                              {{else}}
                                <p class="text-center text-muted">No hay comentarios aún. ¡Sé el primero en comentar!</p>
                              {{/if}}
                            </div>
                          </div>


                      </div>

                    </div>
                  </div>

                  <div class="col-md-8">
                    <div class="card mb-3">
                      <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Información del Cargo</h5>
                      </div>
                      <div class="card-body">
                        <table class="table-responsive table-borderless">
                          <tr class="position-table-row">
                            <th class="position-table-header">Cargo:</th>
                            <td>{{ candidate.position_name }}</td>
                          </tr>
                          <tr class="position-table-row">
                            <th class="position-table-header">Estado:</th>
                            <td>{{ candidate.state_name }}</td>
                          </tr>
                          {{#if candidate.district_name}}
                          <tr class="position-table-row">
                            <th class="position-table-header">Distrito:</th>
                            <td>{{ candidate.district_name }}</td>
                          </tr>
                          {{/if}}
                          <tr class="position-table-row">
                            <th class="position-table-header">Poder:</th>
                            <td>{{ candidate.poder_name }}</td>
                          </tr>
                          {{#if candidate.matter_name}}
                          <tr class="position-table-row">
                            <th class="position-table-header">Materia:</th>
                            <td>{{ candidate.matter_name }}</td>
                          </tr>
                          {{/if}}
                          <tr class="position-table-row">
                            <th class="position-table-header">Número en Boleta:</th>
                            <td>{{ candidate.num_boleta }}</td>
                          </tr>
                        </table>
                      </div>
                    </div>

                    <div class="card mb-3">
                      <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Contacto</h5>
                      </div>
                      <div class="card-body">
                        {{#if candidate.email}}
                        <p><i class="fa fa-envelope"></i> <a href="mailto:{{ candidate.email }}">{{ candidate.email }}</a></p>
                        {{else}}
                        <p><i class="fa fa-envelope"></i> No disponible</p>
                        {{/if}}

                        {{#if candidate.telephone}}
                        <p><i class="fa fa-phone"></i> <a href="tel:{{ candidate.telephone }}">{{ candidate.telephone }}</a></p>
                        {{else}}
                        <p><i class="fa fa-phone"></i> No disponible</p>
                        {{/if}}
                      </div>
                    </div>

                    {{#if candidate.raw_data.extras}}
                    <div class="card">
                      <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Información Adicional</h5>
                      </div>
                      <div class="card-body">
                        <div class="accordion" id="extrasAccordion">
                          {{#each candidate.raw_data.extras}}
                          <div class="card">
                            <div class="card-header" id="heading{{@index}}">
                              <h2 class="mb-0">
                                <button class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#collapse{{@index}}">
                                  {{ this.question }}
                                </button>
                              </h2>
                            </div>
                            <div id="collapse{{@index}}" class="collapse" data-parent="#extrasAccordion">
                              <div class="card-body">
                                {{ this.answer }}
                              </div>
                            </div>
                          </div>
                          {{/each}}
                        </div>
                      </div>
                    </div>
                    {{/if}}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row justify-content-center mt-4">
          <div class="col-md-4 text-center">
            <a href="/candidates/{{ candidate.state }}" class="btn btn-secondary">
              <i class="fa fa-arrow-left"></i> Volver a la lista
            </a>
          </div>
        </div>
      </div>
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.7/handlebars.min.js"></script>
    <script src="/js/app.js"></script>

    <style>
      .reaction-group {
        display: flex;
        align-items: center;
      }

      .reaction-count {
        margin-right: 10px;
        font-size: 12px;
        font-weight: bold;
      }

      .reaction-btn {
        margin-right: 3px;
      }


      .comment-item {
        background-color: #f9f9f9;
      }

      .comment-author {
        font-weight: bold;
        margin-bottom: 5px;
      }

      .comment-text {
        margin-bottom: 5px;
      }

      #candidate-comments {
        border-top: 1px solid #dee2e6;
        padding-top: 15px;
      }

    </style>

    <script>
        // Register Handlebars helper for equality check
        const LOGIN_PATH = "/login/facebook";
        var CURRENT_USER = {};
        // Register Handlebars helper for equality check
        Handlebars.registerHelper('eq', function(a, b) {
            return a === b;
        });

        $(document).ready(function() {
            // Checks every 30 minutes
            setupLoginCheck(30);


            // Load comments when page loads
            // TODO check if needed: loadCandidateComments({{candidate.id}});

            // Handle reaction button clicks
            $(document).on('click', '.reaction-btn', function() {
                const candidateId = $(this).data('candidate-id');
                const reactionType = $(this).data('reaction-type');

                // Check if the user is logged in
                if ( isEmpty(CURRENT_USER) ) {
                    alert("Debes acceder antes de poder comentar o poner una reacción");
                    return;
                }

                // Build payload
                var reaction_payload = {
                    user_id: CURRENT_USER.id,
                    candidate_id: candidateId,
                    oauth_user_id: CURRENT_USER.oauth_id,
                    reaction_type: reactionType,
                };

                // Send reaction to server
                $.ajax({
                    url: `/candidates/${candidateId}/reaction`,
                    method: 'PUT',
                    data: JSON.stringify(reaction_payload),
                    contentType: 'application/json',
                    success: function() {
                        // Reload reactions for this candidate to update counts
                        console.log("Load reactions...");
                        loadCandidateReactions(candidateId);
                    },
                    error: function(err) {
                        console.error('Error sending reaction', err);
                    }
                });
            });


            // Comments Functions

            // Handle comment submission
            $('#submit-comment').on('click', function() {
                const candidateId = $(this).data('candidate-id');
                const commentText = $('#comment-text').val().trim();

                // Validate comment text
                if (!commentText) {
                    alert('Por favor escribe un comentario antes de publicar.');
                    return;
                }

                // Check if the user is logged in
                if (isEmpty(CURRENT_USER)) {
                    alert('Debes acceder antes de poder comentar.');
                    return;
                }

                // Build comment payload
                const commentPayload = {
                    user_id: CURRENT_USER.id,
                    oauth_user_id: CURRENT_USER.oauth_id,
                    candidate_id: candidateId,
                    comment_text: commentText,
                    user_name: CURRENT_USER.name || 'Usuario'
                };

                // Send comment to server
                $.ajax({
                    url: `/candidates/${candidateId}/comment`,
                    method: 'PUT',
                    data: JSON.stringify(commentPayload),
                    contentType: 'application/json',
                    success: function(response) {
                        // Clear the comment field
                        $('#comment-text').val('');

                        // Reload comments to show the new one
                        loadCandidateComments(candidateId);
                    },
                    error: function(err) {
                        console.error('Error al enviar comentario', err);
                        alert('Error al enviar tu comentario. Por favor intenta nuevamente.');
                    }
                }); // ajax request
            }); //  submit-comment click event
        }); // document.ready


        // Function to load candidate comments
        function loadCandidateComments(candidateId) {
            $.ajax({
                url: `/candidates/${candidateId}/comments`,
                method: 'GET',
                success: function(comments) {
                    // Clear existing comments
                    const commentsContainer = $('#comments-container');
                    commentsContainer.empty();

                    // If no comments, show a message
                    if (!comments || comments.length === 0) {
                        commentsContainer.html('<p class="text-center text-muted">No hay comentarios aún. ¡Sé el primero en comentar!</p>');
                        return;
                    }

                    // Add each comment to the container
                    comments.forEach(function(comment) {
                        const commentHtml = `
                            <div class="comment-item card mb-2">
                                <div class="card-body">
                                    <h6 class="comment-author">${comment.user_name}</h6>
                                    <p class="comment-text">${comment.comment_text}</p>
                                    <small class="text-muted">${formatDate(comment.created_at)}</small>
                                </div>
                            </div>
                        `;
                        commentsContainer.append(commentHtml);
                    }); // comments.forEach
                }, // success function
                error: function(err) {
                    console.error('Error loading comments', err);
                    $('#comments-container').html('<p class="text-center text-danger">Error al cargar comentarios.</p>');
                } // error function
            }); // ajax GET
        } // loadCandidateComments

        // Helper function to format dates
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } // formatDate
    </script>
  </body>
</html>
